<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste TikTok Purchase Event</title>
    <!-- TikTok Pixel Code Start -->
    <script>
    !function (w, d, t) {
      w.TiktokAnalyticsObject=t;var ttq=w[t]=w[t]||[];ttq.methods=["page","track","identify","instances","debug","on","off","once","ready","alias","group","enableCookie","disableCookie","holdConsent","revokeConsent","grantConsent"],ttq.setAndDefer=function(t,e){t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}};for(var i=0;i<ttq.methods.length;i++)ttq.setAndDefer(ttq,ttq.methods[i]);ttq.instance=function(t){for(
    var e=ttq._i[t]||[],n=0;n<ttq.methods.length;n++)ttq.setAndDefer(e,ttq.methods[n]);return e},ttq.load=function(e,n){var r="https://analytics.tiktok.com/i18n/pixel/events.js",o=n&&n.partner;ttq._i=ttq._i||{},ttq._i[e]=[],ttq._i[e]._u=r,ttq._t=ttq._t||{},ttq._t[e]=+new Date,ttq._o=ttq._o||{},ttq._o[e]=n||{};n=document.createElement("script")
    ;n.type="text/javascript",n.async=!0,n.src=r+"?sdkid="+e+"&lib="+t;e=document.getElementsByTagName("script")[0];e.parentNode.insertBefore(n,e)};

      ttq.load('D1QFD0RC77UF6MBM48MG');
      ttq.page();
    }(window, document, 'ttq');
    </script>
    <!-- TikTok Pixel Code End -->
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        button {
            background: #d4af37;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 5px;
        }
        button:hover {
            background: #b8941f;
        }
        .log {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        input, select {
            margin: 5px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>üß™ Teste TikTok Purchase Event - Devotly</h1>
    <p>Esta p√°gina permite testar os eventos Purchase do TikTok Pixel e Events API.</p>

    <div class="test-section">
        <h2>üìä Configura√ß√£o do Teste</h2>
        <div>
            <label>Content ID:</label>
            <input type="text" id="contentId" value="test_card_123" placeholder="ID do produto">
        </div>
        <div>
            <label>Content Name:</label>
            <input type="text" id="contentName" value="Plano Devotly Para Sempre" placeholder="Nome do produto">
        </div>
        <div>
            <label>Valor:</label>
            <input type="number" id="value" value="17.99" step="0.01" placeholder="Valor da compra">
        </div>
        <div>
            <label>Moeda:</label>
            <select id="currency">
                <option value="BRL">BRL</option>
                <option value="USD">USD</option>
            </select>
        </div>
        <div>
            <label>Email (ser√° hasheado):</label>
            <input type="email" id="email" placeholder="test@devotly.shop">
        </div>
        <div>
            <label>Telefone (ser√° hasheado):</label>
            <input type="tel" id="phone" placeholder="+5511999999999">
        </div>
    </div>

    <div class="test-section">
        <h2>üéØ Testes de Purchase Event</h2>
        <button onclick="testPurchaseViaPixel()">üî• Teste via TikTok Pixel (ttq.track)</button>
        <button onclick="testPurchaseViaAPI()">üöÄ Teste via Events API Backend</button>
        <button onclick="testPurchaseViaTikTokEvents()">‚ö° Teste via TikTokEvents (H√≠brido)</button>
        <button onclick="clearLogs()">üßπ Limpar Logs</button>
    </div>

    <div class="test-section">
        <h2>üìã Logs de Teste</h2>
        <div id="testLogs" class="log">Logs aparecer√£o aqui...\n</div>
    </div>

    <script src="js/tiktok-events-optimized.js"></script>
    <script>
        function log(message) {
            const logElement = document.getElementById('testLogs');
            const timestamp = new Date().toISOString();
            logElement.textContent += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message);
        }

        function getTestData() {
            return {
                contentId: document.getElementById('contentId').value,
                contentName: document.getElementById('contentName').value,
                value: parseFloat(document.getElementById('value').value),
                currency: document.getElementById('currency').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value
            };
        }

        async function testPurchaseViaPixel() {
            const data = getTestData();
            log(`üî• TESTE PIXEL: Iniciando Purchase via ttq.track`);
            log(`üìä Dados: ${JSON.stringify(data, null, 2)}`);

            try {
                if (typeof ttq === 'undefined') {
                    throw new Error('TikTok Pixel (ttq) n√£o est√° carregado');
                }

                const eventId = 'test_pixel_' + Date.now();
                const eventData = {
                    event_id: eventId,
                    contents: [{
                        content_id: data.contentId,
                        content_type: 'product',
                        content_name: data.contentName,
                        quantity: 1,
                        price: data.value
                    }],
                    value: data.value,
                    currency: data.currency
                };

                // Adicionar dados de usu√°rio se fornecidos
                if (data.email) {
                    eventData.email = data.email; // TikTok vai hashear automaticamente
                }
                if (data.phone) {
                    eventData.phone_number = data.phone; // TikTok vai hashear automaticamente
                }

                ttq.track('Purchase', eventData);
                log(`‚úÖ PIXEL: Purchase enviado com event_id: ${eventId}`);
                log(`üìà PIXEL: Dados enviados: ${JSON.stringify(eventData, null, 2)}`);

            } catch (error) {
                log(`‚ùå PIXEL: Erro: ${error.message}`);
            }
        }

        async function testPurchaseViaAPI() {
            const data = getTestData();
            log(`üöÄ TESTE API: Iniciando Purchase via Backend Events API`);
            log(`üìä Dados: ${JSON.stringify(data, null, 2)}`);

            try {
                const apiUrl = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
                    ? 'http://localhost:3000'
                    : 'https://devotly-full-production.up.railway.app';

                const payload = {
                    eventName: 'Purchase',
                    eventData: {
                        content_id: data.contentId,
                        content_type: 'product',
                        content_name: data.contentName,
                        content_category: 'digital_product',
                        value: data.value,
                        currency: data.currency,
                        quantity: 1
                    },
                    userData: {
                        email: data.email,
                        phone: data.phone
                    },
                    eventId: 'test_api_' + Date.now(),
                    timestamp: Math.floor(Date.now() / 1000),
                    userAgent: navigator.userAgent,
                    url: window.location.href,
                    referrer: document.referrer
                };

                log(`üì§ API: Enviando para ${apiUrl}/api/tiktok/track-event`);
                log(`üì¶ API: Payload: ${JSON.stringify(payload, null, 2)}`);

                const response = await fetch(`${apiUrl}/api/tiktok/track-event`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    const result = await response.json();
                    log(`‚úÖ API: Resposta recebida: ${JSON.stringify(result, null, 2)}`);
                } else {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

            } catch (error) {
                log(`‚ùå API: Erro: ${error.message}`);
            }
        }

        async function testPurchaseViaTikTokEvents() {
            const data = getTestData();
            log(`‚ö° TESTE H√çBRIDO: Iniciando Purchase via TikTokEvents`);
            log(`üìä Dados: ${JSON.stringify(data, null, 2)}`);

            try {
                // Identificar usu√°rio primeiro se h√° dados
                if (data.email || data.phone) {
                    if (typeof TikTokEvents !== 'undefined' && TikTokEvents.identifyUser) {
                        const userId = data.email ? 'test_user_' + btoa(data.email).substr(0, 12) : null;
                        TikTokEvents.identifyUser(data.email, data.phone, userId);
                        log(`üîç H√çBRIDO: Usu√°rio identificado`);
                    }
                }

                // Chamar Purchase via TikTokEvents
                if (typeof TikTokEvents !== 'undefined' && TikTokEvents.trackPurchase) {
                    const result = TikTokEvents.trackPurchase(data.contentId, data.contentName, data.value, data.currency);
                    log(`‚úÖ H√çBRIDO: TikTokEvents.trackPurchase chamado`);
                    log(`üìà H√çBRIDO: Resultado: ${result}`);
                } else {
                    throw new Error('TikTokEvents n√£o est√° dispon√≠vel');
                }

            } catch (error) {
                log(`‚ùå H√çBRIDO: Erro: ${error.message}`);
            }
        }

        function clearLogs() {
            document.getElementById('testLogs').textContent = 'Logs limpos...\n';
        }

        // Log de inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            log('üß™ P√°gina de teste carregada');
            log('üéØ Pixel Code: D1QFD0RC77UF6MBM48MG');
            log('üîß Aguardando TikTok Pixel carregar...');

            // Verificar quando ttq estiver dispon√≠vel
            const checkTtq = setInterval(() => {
                if (typeof ttq !== 'undefined') {
                    log('‚úÖ TikTok Pixel (ttq) carregado e pronto');
                    clearInterval(checkTtq);
                }
            }, 100);

            // Verificar quando TikTokEvents estiver dispon√≠vel
            const checkTikTokEvents = setInterval(() => {
                if (typeof TikTokEvents !== 'undefined') {
                    log('‚úÖ TikTokEvents carregado e pronto');
                    clearInterval(checkTikTokEvents);
                }
            }, 100);

            // Timeout ap√≥s 10 segundos
            setTimeout(() => {
                if (typeof ttq === 'undefined') {
                    log('‚ö†Ô∏è TikTok Pixel n√£o carregou em 10s');
                }
                if (typeof TikTokEvents === 'undefined') {
                    log('‚ö†Ô∏è TikTokEvents n√£o carregou em 10s');
                }
            }, 10000);
        });
    </script>
</body>
</html>
