<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste TikTok EMQ - Devotly</title>
    <!-- TikTok Pixel Code Start -->
<script>
!function (w, d, t) {
  w.TiktokAnalyticsObject=t;var ttq=w[t]=w[t]||[];ttq.methods=["page","track","identify","instances","debug","on","off","once","ready","alias","group","enableCookie","disableCookie","holdConsent","revokeConsent","grantConsent"],ttq.setAndDefer=function(t,e){t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}};for(var i=0;i<ttq.methods.length;i++)ttq.setAndDefer(ttq,ttq.methods[i]);ttq.instance=function(t){for(
var e=ttq._i[t]||[],n=0;n<ttq.methods.length;n++)ttq.setAndDefer(e,ttq.methods[n]);return e},ttq.load=function(e,n){var r="https://analytics.tiktok.com/i18n/pixel/events.js",o=n&&n.partner;ttq._i=ttq._i||{},ttq._i[e]=[],ttq._i[e]._u=r,ttq._t=ttq._t||{},ttq._t[e]=+new Date,ttq._o=ttq._o||{},ttq._o[e]=n||{};n=document.createElement("script")
;n.type="text/javascript",n.async=!0,n.src=r+"?sdkid="+e+"&lib="+t;e=document.getElementsByTagName("script")[0];e.parentNode.insertBefore(n,e)};

  ttq.load('D1QFD0RC77UF6MBM48MG');
  ttq.page();
}(window, document, 'ttq');
</script>
<!-- TikTok Pixel Code End -->
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        .button { padding: 10px 20px; margin: 10px; background: #d4af37; color: white; border: none; border-radius: 5px; cursor: pointer; }
        .form-group { margin: 10px 0; }
        label { display: block; margin-bottom: 5px; }
        input { padding: 8px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px; width: 200px; }
        .log { background: #f0f0f0; padding: 10px; margin: 10px 0; border-radius: 4px; font-family: monospace; white-space: pre-wrap; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
    </style>
</head>
<body>
    <h1>üéØ Teste de Qualidade EMQ - TikTok Pixel</h1>
    <p>Esta p√°gina permite testar as melhorias implementadas para aumentar o Event Match Quality (EMQ) do TikTok Pixel.</p>
    
    <div class="test-section">
        <h2>üìä Status do Sistema</h2>
        <div id="systemStatus"></div>
        <button class="button" onclick="checkSystemStatus()">Verificar Status</button>
    </div>

    <div class="test-section">
        <h2>üë§ Identifica√ß√£o de Usu√°rio</h2>
        <div class="form-group">
            <label>Email:</label>
            <input type="email" id="testEmail" placeholder="teste@exemplo.com" value="usuario.teste@devotly.shop">
        </div>
        <div class="form-group">
            <label>Telefone:</label>
            <input type="tel" id="testPhone" placeholder="(11) 99999-9999" value="11987654321">
        </div>
        <button class="button" onclick="testUserIdentification()">Identificar Usu√°rio</button>
        <div id="identificationLog" class="log"></div>
    </div>

    <div class="test-section">
        <h2>üîò Teste de ClickButton</h2>
        <button class="button" onclick="testClickButton()">Testar ClickButton</button>
        <div id="clickButtonLog" class="log"></div>
    </div>

    <div class="test-section">
        <h2>üõí Teste de InitiateCheckout</h2>
        <button class="button" onclick="testInitiateCheckout()">Testar InitiateCheckout</button>
        <div id="checkoutLog" class="log"></div>
    </div>

    <div class="test-section">
        <h2>üí∞ Teste de Purchase</h2>
        <button class="button" onclick="testPurchase()">Testar Purchase</button>
        <div id="purchaseLog" class="log"></div>
    </div>

    <div class="test-section">
        <h2>üîç Par√¢metros TikTok</h2>
        <p>Para testar a captura de par√¢metros TikTok, adicione √† URL:</p>
        <code>?ttclid=test_click_id_123&ttp=test_tracking_param</code>
        <br><br>
        <button class="button" onclick="checkTikTokParams()">Verificar Par√¢metros</button>
        <div id="paramsLog" class="log"></div>
    </div>

    <div class="test-section">
        <h2>üìù Logs Completos</h2>
        <button class="button" onclick="clearLogs()">Limpar Logs</button>
        <button class="button" onclick="downloadLogs()">Download Logs</button>
        <div id="fullLog" class="log" style="max-height: 400px; overflow-y: auto;"></div>
    </div>

    <script src="js/tiktok-events-v3.js"></script>
    <script>
        let allLogs = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toISOString();
            const logEntry = `[${timestamp}] ${message}`;
            allLogs.push(logEntry);
            
            const fullLogDiv = document.getElementById('fullLog');
            const span = document.createElement('span');
            span.className = type;
            span.textContent = logEntry + '\n';
            fullLogDiv.appendChild(span);
            fullLogDiv.scrollTop = fullLogDiv.scrollHeight;
            
            console.log(message);
        }

        function logToSection(sectionId, message, type = 'info') {
            const section = document.getElementById(sectionId);
            const span = document.createElement('span');
            span.className = type;
            span.textContent = message + '\n';
            section.appendChild(span);
            
            log(message, type);
        }

        function checkSystemStatus() {
            const statusDiv = document.getElementById('systemStatus');
            statusDiv.innerHTML = '';
            
            log('=== VERIFICA√á√ÉO DO SISTEMA ===');
            
            // Verificar TikTok Pixel
            if (typeof ttq !== 'undefined') {
                logToSection('systemStatus', '‚úÖ TikTok Pixel (ttq) carregado', 'success');
            } else {
                logToSection('systemStatus', '‚ùå TikTok Pixel (ttq) N√ÉO carregado', 'error');
            }
            
            // Verificar TikTok Events
            if (typeof TikTokEvents !== 'undefined') {
                logToSection('systemStatus', '‚úÖ TikTok Events carregado', 'success');
            } else {
                logToSection('systemStatus', '‚ùå TikTok Events N√ÉO carregado', 'error');
            }
            
            // Verificar fun√ß√µes cr√≠ticas
            if (typeof sha256Base64 === 'function') {
                logToSection('systemStatus', '‚úÖ Fun√ß√£o sha256Base64 dispon√≠vel', 'success');
            } else {
                logToSection('systemStatus', '‚ùå Fun√ß√£o sha256Base64 N√ÉO dispon√≠vel', 'error');
            }
            
            // Verificar localStorage
            try {
                localStorage.setItem('test', 'test');
                localStorage.removeItem('test');
                logToSection('systemStatus', '‚úÖ localStorage funcionando', 'success');
            } catch (e) {
                logToSection('systemStatus', '‚ùå localStorage N√ÉO funcionando', 'error');
            }
            
            // Verificar dados armazenados
            const storedEmail = localStorage.getItem('user_email');
            const storedPhone = localStorage.getItem('user_phone');
            const ttclid = localStorage.getItem('ttclid');
            const ttp = localStorage.getItem('ttp');
            const externalId = localStorage.getItem('devotly_external_id');
            
            logToSection('systemStatus', `üìß Email armazenado: ${storedEmail || 'Nenhum'}`, storedEmail ? 'success' : 'info');
            logToSection('systemStatus', `üì± Telefone armazenado: ${storedPhone || 'Nenhum'}`, storedPhone ? 'success' : 'info');
            logToSection('systemStatus', `üÜî External ID: ${externalId || 'Nenhum'}`, externalId ? 'success' : 'info');
            logToSection('systemStatus', `üéØ TTCLID: ${ttclid || 'Nenhum'}`, ttclid ? 'success' : 'info');
            logToSection('systemStatus', `üìä TTP: ${ttp || 'Nenhum'}`, ttp ? 'success' : 'info');
        }

        async function testUserIdentification() {
            const logDiv = document.getElementById('identificationLog');
            logDiv.innerHTML = '';
            
            const email = document.getElementById('testEmail').value;
            const phone = document.getElementById('testPhone').value;
            
            log('=== TESTE DE IDENTIFICA√á√ÉO DE USU√ÅRIO ===');
            logToSection('identificationLog', `Testando identifica√ß√£o com:`, 'info');
            logToSection('identificationLog', `Email: ${email}`, 'info');
            logToSection('identificationLog', `Telefone: ${phone}`, 'info');
            
            if (typeof TikTokEvents !== 'undefined' && TikTokEvents.identifyUser) {
                try {
                    const result = await TikTokEvents.identifyUser(email, phone, null);
                    if (result) {
                        logToSection('identificationLog', '‚úÖ Usu√°rio identificado com sucesso', 'success');
                    } else {
                        logToSection('identificationLog', '‚ö†Ô∏è Identifica√ß√£o enfileirada (pixel indispon√≠vel)', 'info');
                    }
                } catch (error) {
                    logToSection('identificationLog', `‚ùå Erro na identifica√ß√£o: ${error.message}`, 'error');
                }
            } else {
                logToSection('identificationLog', '‚ùå TikTokEvents.identifyUser n√£o dispon√≠vel', 'error');
            }
        }

        function testClickButton() {
            const logDiv = document.getElementById('clickButtonLog');
            logDiv.innerHTML = '';
            
            log('=== TESTE DE CLICK BUTTON ===');
            
            if (typeof TikTokEvents !== 'undefined' && TikTokEvents.trackClickButton) {
                try {
                    const result = TikTokEvents.trackClickButton('Teste EMQ Button', 'test', 5.00, 'BRL');
                    if (result) {
                        logToSection('clickButtonLog', '‚úÖ ClickButton enviado com sucesso', 'success');
                        logToSection('clickButtonLog', 'Verifique os logs do console para qualidade EMQ', 'info');
                    } else {
                        logToSection('clickButtonLog', '‚ùå Falha ao enviar ClickButton', 'error');
                    }
                } catch (error) {
                    logToSection('clickButtonLog', `‚ùå Erro: ${error.message}`, 'error');
                }
            } else {
                logToSection('clickButtonLog', '‚ùå trackClickButton n√£o dispon√≠vel', 'error');
            }
        }

        function testInitiateCheckout() {
            const logDiv = document.getElementById('checkoutLog');
            logDiv.innerHTML = '';
            
            log('=== TESTE DE INITIATE CHECKOUT ===');
            
            if (typeof TikTokEvents !== 'undefined' && TikTokEvents.startCheckout) {
                try {
                    TikTokEvents.startCheckout('test_card_123', 'para_sempre', 17.99);
                    logToSection('checkoutLog', '‚úÖ InitiateCheckout enviado com sucesso', 'success');
                } catch (error) {
                    logToSection('checkoutLog', `‚ùå Erro: ${error.message}`, 'error');
                }
            } else {
                logToSection('checkoutLog', '‚ùå startCheckout n√£o dispon√≠vel', 'error');
            }
        }

        function testPurchase() {
            const logDiv = document.getElementById('purchaseLog');
            logDiv.innerHTML = '';
            
            log('=== TESTE DE PURCHASE ===');
            
            if (typeof TikTokEvents !== 'undefined' && TikTokEvents.completePurchase) {
                try {
                    TikTokEvents.completePurchase('test_card_123', 'para_sempre', 17.99);
                    logToSection('purchaseLog', '‚úÖ Purchase enviado com sucesso', 'success');
                } catch (error) {
                    logToSection('purchaseLog', `‚ùå Erro: ${error.message}`, 'error');
                }
            } else {
                logToSection('purchaseLog', '‚ùå completePurchase n√£o dispon√≠vel', 'error');
            }
        }

        function checkTikTokParams() {
            const logDiv = document.getElementById('paramsLog');
            logDiv.innerHTML = '';
            
            log('=== VERIFICA√á√ÉO DE PAR√ÇMETROS TIKTOK ===');
            
            const urlParams = new URLSearchParams(window.location.search);
            const ttclid = urlParams.get('ttclid') || localStorage.getItem('ttclid');
            const ttp = urlParams.get('ttp') || localStorage.getItem('ttp');
            
            logToSection('paramsLog', `TTCLID (URL): ${urlParams.get('ttclid') || 'N√£o encontrado'}`, 'info');
            logToSection('paramsLog', `TTCLID (Armazenado): ${localStorage.getItem('ttclid') || 'N√£o encontrado'}`, 'info');
            logToSection('paramsLog', `TTP (URL): ${urlParams.get('ttp') || 'N√£o encontrado'}`, 'info');
            logToSection('paramsLog', `TTP (Armazenado): ${localStorage.getItem('ttp') || 'N√£o encontrado'}`, 'info');
            
            if (ttclid || ttp) {
                logToSection('paramsLog', '‚úÖ Par√¢metros TikTok encontrados', 'success');
            } else {
                logToSection('paramsLog', '‚ö†Ô∏è Nenhum par√¢metro TikTok encontrado', 'info');
                logToSection('paramsLog', 'Adicione ?ttclid=test123&ttp=test456 √† URL para testar', 'info');
            }
        }

        function clearLogs() {
            allLogs = [];
            document.getElementById('fullLog').innerHTML = '';
            log('Logs limpos');
        }

        function downloadLogs() {
            const logsText = allLogs.join('\n');
            const blob = new Blob([logsText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `tiktok-emq-test-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.log`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            log('Logs baixados');
        }

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', () => {
            log('=== P√ÅGINA DE TESTE EMQ CARREGADA ===');
            setTimeout(() => {
                checkSystemStatus();
            }, 2000); // Aguarda carregamento dos scripts
        });

        // Monitorar erros
        window.addEventListener('error', (e) => {
            log(`‚ùå ERRO: ${e.message} em ${e.filename}:${e.lineno}`, 'error');
        });

        // Interceptar logs do console para mostrar na p√°gina
        const originalLog = console.log;
        console.log = function(...args) {
            originalLog.apply(console, args);
            if (args[0] && args[0].includes && args[0].includes('TikTok:')) {
                log(args.join(' '));
            }
        };
    </script>
</body>
</html>
