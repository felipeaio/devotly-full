<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéØ TikTok Events v3.0 - Sistema EMQ Avan√ßado</title>
    <!-- TikTok Pixel Code Start -->
    <script>
    !function (w, d, t) {
      w.TiktokAnalyticsObject=t;var ttq=w[t]=w[t]||[];ttq.methods=["page","track","identify","instances","debug","on","off","once","ready","alias","group","enableCookie","disableCookie","holdConsent","revokeConsent","grantConsent"],ttq.setAndDefer=function(t,e){t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}};for(var i=0;i<ttq.methods.length;i++)ttq.setAndDefer(ttq,ttq.methods[i]);ttq.instance=function(t){for(
    var e=ttq._i[t]||[],n=0;n<ttq.methods.length;n++)ttq.setAndDefer(e,ttq.methods[n]);return e},ttq.load=function(e,n){var r="https://analytics.tiktok.com/i18n/pixel/events.js",o=n&&n.partner;ttq._i=ttq._i||{},ttq._i[e]=[],ttq._i[e]._u=r,ttq._t=ttq._t||{},ttq._t[e]=+new Date,ttq._o=ttq._o||{},ttq._o[e]=n||{};n=document.createElement("script")
    ;n.type="text/javascript",n.async=!0,n.src=r+"?sdkid="+e+"&lib="+t;e=document.getElementsByTagName("script")[0];e.parentNode.insertBefore(n,e)};

      ttq.load('D1QFD0RC77UF6MBM48MG');
      ttq.page();
    }(window, document, 'ttq');
    </script>
    <!-- TikTok Pixel Code End -->
    <style>
        :root {
            --primary: #ff0050;
            --secondary: #00f2ea;
            --success: #25f4ab;
            --warning: #fe2c55;
            --dark: #161823;
            --light: #fafafa;
            --gray: #69677a;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--dark), #2c2847);
            color: var(--light);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            color: var(--gray);
            font-size: 1.1rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 25px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
            color: var(--success);
        }

        .stat-label {
            color: var(--gray);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .section {
            background: rgba(255, 255, 255, 0.05);
            margin-bottom: 30px;
            padding: 30px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .section h2 {
            color: var(--secondary);
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--light);
            font-weight: 500;
        }

        .input-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            color: var(--light);
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .input-group input:focus {
            outline: none;
            border-color: var(--secondary);
            background: rgba(255, 255, 255, 0.1);
        }

        .btn {
            background: linear-gradient(45deg, var(--primary), var(--warning));
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            margin: 5px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(255, 0, 80, 0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: linear-gradient(45deg, var(--secondary), #4a90e2);
        }

        .btn-success {
            background: linear-gradient(45deg, var(--success), #20c997);
        }

        .log-container {
            background: #000;
            border: 1px solid var(--gray);
            border-radius: 8px;
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .log-entry {
            margin-bottom: 5px;
            padding: 5px;
            border-radius: 3px;
        }

        .log-info { color: #17a2b8; }
        .log-success { color: #28a745; }
        .log-warning { color: #ffc107; }
        .log-error { color: #dc3545; }

        .quality-indicator {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: bold;
            margin: 2px;
            text-transform: uppercase;
        }

        .quality-excellent {
            background: var(--success);
            color: var(--dark);
        }

        .quality-good {
            background: #28a745;
            color: white;
        }

        .quality-fair {
            background: #ffc107;
            color: var(--dark);
        }

        .quality-poor {
            background: var(--warning);
            color: white;
        }

        .emq-score-display {
            text-align: center;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            font-size: 1.2rem;
            font-weight: bold;
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, var(--success), var(--secondary));
            transition: width 0.5s ease;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .grid-2 {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ TikTok Events v3.0</h1>
            <p>Sistema de EMQ Avan√ßado - Target: 70+ pontos</p>
        </div>

        <!-- M√©tricas EMQ -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="emqScore">--</div>
                <div class="stat-label">EMQ Score M√©dio</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="eventsSent">0</div>
                <div class="stat-label">Eventos Enviados</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="successRate">--</div>
                <div class="stat-label">Taxa de Sucesso</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="hashSuccess">--</div>
                <div class="stat-label">Hash Success Rate</div>
            </div>
        </div>

        <div class="grid-2">
            <!-- Identifica√ß√£o do Usu√°rio -->
            <div class="section">
                <h2>üë§ Identifica√ß√£o do Usu√°rio</h2>
                <div class="input-group">
                    <label for="userEmail">Email:</label>
                    <input type="email" id="userEmail" placeholder="exemplo@email.com">
                </div>
                <div class="input-group">
                    <label for="userPhone">Telefone:</label>
                    <input type="tel" id="userPhone" placeholder="+5511999999999">
                </div>
                <div class="input-group">
                    <label for="userId">User ID (opcional):</label>
                    <input type="text" id="userId" placeholder="user_123">
                </div>
                <button class="btn btn-secondary" onclick="identifyUser()">üîç Identificar Usu√°rio</button>
                <button class="btn" onclick="clearUserData()">üóëÔ∏è Limpar Dados</button>
            </div>

            <!-- Qualidade dos Dados -->
            <div class="section">
                <h2>üìä Qualidade dos Dados</h2>
                <div id="dataQuality">
                    <div>Email: <span class="quality-indicator quality-poor" id="emailQuality">N√£o Definido</span></div>
                    <div>Telefone: <span class="quality-indicator quality-poor" id="phoneQuality">N√£o Definido</span></div>
                    <div>User ID: <span class="quality-indicator quality-poor" id="userIdQuality">N√£o Definido</span></div>
                    <div>TTCLID: <span class="quality-indicator quality-poor" id="ttclidQuality">N√£o Detectado</span></div>
                </div>
                <div class="emq-score-display" id="currentEMQ">
                    EMQ Estimado: <span id="estimatedEMQ">20</span>/100
                    <div class="progress-bar">
                        <div class="progress-fill" id="emqProgress" style="width: 20%"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Testes de Eventos -->
        <div class="section">
            <h2>üéØ Testes de Eventos</h2>
            <div class="grid-2">
                <div>
                    <h3>Eventos B√°sicos</h3>
                    <button class="btn" onclick="testPageView()">üìÑ PageView</button>
                    <button class="btn" onclick="testViewContent()">üëÅÔ∏è ViewContent</button>
                    <button class="btn" onclick="testLead()">üìã Lead</button>
                    <button class="btn" onclick="testContact()">üìû Contact</button>
                </div>
                <div>
                    <h3>Eventos de Convers√£o</h3>
                    <button class="btn btn-success" onclick="testInitiateCheckout()">üõí InitiateCheckout</button>
                    <button class="btn btn-success" onclick="testPurchase()">üí∞ Purchase (R$ 97)</button>
                    <button class="btn btn-secondary" onclick="testClickButton()">üîò ClickButton</button>
                </div>
            </div>
        </div>

        <!-- Testes Espec√≠ficos do Devotly -->
        <div class="section">
            <h2>‚úùÔ∏è Eventos Devotly</h2>
            <button class="btn" onclick="testDevotlyEvents('viewHomePage')">üè† Home Page</button>
            <button class="btn" onclick="testDevotlyEvents('viewCreatePage')">‚úèÔ∏è Create Page</button>
            <button class="btn" onclick="testDevotlyEvents('viewCard')">üé¥ View Card</button>
            <button class="btn btn-secondary" onclick="testDevotlyEvents('selectPlan')">üìã Select Plan</button>
            <button class="btn btn-success" onclick="testDevotlyEvents('startCheckout')">üõí Start Checkout</button>
            <button class="btn btn-success" onclick="testDevotlyEvents('completePurchase')">‚úÖ Complete Purchase</button>
        </div>

        <!-- Status do Backend -->
        <div class="section">
            <h2>üîß Status do Sistema</h2>
            <button class="btn btn-secondary" onclick="checkBackendStatus()">üìä Status Backend</button>
            <button class="btn" onclick="runBackendTest()">üß™ Teste de Configura√ß√£o</button>
            <button class="btn" onclick="resetMetrics()">üîÑ Reset M√©tricas</button>
            <button class="btn" onclick="updateStats()">üìà Atualizar M√©tricas</button>
        </div>

        <!-- Console de Logs -->
        <div class="section">
            <h2>üìã Console de Logs</h2>
            <div class="log-container" id="logContainer">
                <div class="log-entry log-info">üöÄ Sistema TikTok Events v3.0 carregado</div>
                <div class="log-entry log-info">üéØ Target EMQ: 70+ pontos</div>
                <div class="log-entry log-info">‚è≥ Aguardando TikTok Pixel carregar...</div>
            </div>
            <button class="btn" onclick="clearLogs()" style="margin-top: 10px;">üóëÔ∏è Limpar Logs</button>
        </div>
    </div>

    <!-- TikTok Events v3.0 -->
    <script src="js/tiktok-events-v3.js"></script>
    
    <script>
        // Sistema de logs
        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function clearLogs() {
            document.getElementById('logContainer').innerHTML = '';
            addLog('üóëÔ∏è Logs limpos', 'info');
        }

        // Identifica√ß√£o do usu√°rio
        async function identifyUser() {
            const email = document.getElementById('userEmail').value;
            const phone = document.getElementById('userPhone').value;
            const userId = document.getElementById('userId').value;

            if (!email && !phone && !userId) {
                addLog('‚ùå Pelo menos um campo de identifica√ß√£o √© obrigat√≥rio', 'error');
                return;
            }

            addLog('üîç Identificando usu√°rio...', 'info');

            try {
                const result = await TikTokEvents.identifyUser(email, phone, userId);
                
                if (result.success) {
                    addLog(`‚úÖ Usu√°rio identificado (EMQ: ${result.emqScore})`, 'success');
                    updateDataQuality();
                    updateStats();
                } else {
                    addLog(`‚ùå Erro na identifica√ß√£o: ${result.error}`, 'error');
                }
            } catch (error) {
                addLog(`‚ùå Erro: ${error.message}`, 'error');
            }
        }

        function clearUserData() {
            document.getElementById('userEmail').value = '';
            document.getElementById('userPhone').value = '';
            document.getElementById('userId').value = '';
            
            // Limpar cache
            localStorage.removeItem('devotly_user_email');
            localStorage.removeItem('devotly_user_phone');
            localStorage.removeItem('devotly_user_id');
            
            // Reset do manager
            if (window.TikTokManager) {
                window.TikTokManager.userCache = {
                    email: null,
                    phone: null,
                    userId: null,
                    hashedData: {},
                    ttclid: null,
                    ttp: null,
                    fbp: null,
                    fbc: null,
                    validated: false
                };
            }
            
            addLog('üóëÔ∏è Dados do usu√°rio limpos', 'info');
            updateDataQuality();
        }

        // Atualizar qualidade dos dados
        function updateDataQuality() {
            const manager = window.TikTokManager;
            if (!manager) return;

            const updateQuality = (elementId, hasData) => {
                const element = document.getElementById(elementId);
                if (hasData) {
                    element.textContent = 'Definido';
                    element.className = 'quality-indicator quality-good';
                } else {
                    element.textContent = 'N√£o Definido';
                    element.className = 'quality-indicator quality-poor';
                }
            };

            updateQuality('emailQuality', !!manager.userCache.email);
            updateQuality('phoneQuality', !!manager.userCache.phone);
            updateQuality('userIdQuality', !!manager.userCache.userId);
            updateQuality('ttclidQuality', !!manager.userCache.ttclid);

            // Calcular EMQ estimado
            let emqScore = 20;
            if (manager.userCache.email) emqScore += 25;
            if (manager.userCache.phone) emqScore += 25;
            if (manager.userCache.userId) emqScore += 15;
            if (manager.userCache.ttclid) emqScore += 10;
            emqScore += 5; // User agent sempre presente

            document.getElementById('estimatedEMQ').textContent = emqScore;
            document.getElementById('emqProgress').style.width = `${emqScore}%`;

            const emqDisplay = document.getElementById('currentEMQ');
            if (emqScore >= 70) {
                emqDisplay.style.background = 'rgba(37, 244, 171, 0.2)';
                emqDisplay.style.border = '1px solid #25f4ab';
            } else if (emqScore >= 60) {
                emqDisplay.style.background = 'rgba(40, 167, 69, 0.2)';
                emqDisplay.style.border = '1px solid #28a745';
            } else if (emqScore >= 40) {
                emqDisplay.style.background = 'rgba(255, 193, 7, 0.2)';
                emqDisplay.style.border = '1px solid #ffc107';
            } else {
                emqDisplay.style.background = 'rgba(254, 44, 85, 0.2)';
                emqDisplay.style.border = '1px solid #fe2c55';
            }
        }

        // Testes de eventos
        async function testPageView() {
            addLog('üìÑ Testando PageView...', 'info');
            try {
                const result = await TikTokEvents.trackPageView();
                addLog(`‚úÖ PageView enviado (EMQ: ${result.emqScore})`, 'success');
                updateStats();
            } catch (error) {
                addLog(`‚ùå Erro no PageView: ${error.message}`, 'error');
            }
        }

        async function testViewContent() {
            addLog('üëÅÔ∏è Testando ViewContent...', 'info');
            try {
                const result = await TikTokEvents.trackViewContent('test-content-123', 'Conte√∫do de Teste', 15.90);
                addLog(`‚úÖ ViewContent enviado (EMQ: ${result.emqScore})`, 'success');
                updateStats();
            } catch (error) {
                addLog(`‚ùå Erro no ViewContent: ${error.message}`, 'error');
            }
        }

        async function testLead() {
            addLog('üìã Testando Lead...', 'info');
            try {
                const result = await TikTokEvents.trackLead('test_lead', 25);
                addLog(`‚úÖ Lead enviado (EMQ: ${result.emqScore})`, 'success');
                updateStats();
            } catch (error) {
                addLog(`‚ùå Erro no Lead: ${error.message}`, 'error');
            }
        }

        async function testContact() {
            addLog('üìû Testando Contact...', 'info');
            try {
                const result = await TikTokEvents.trackContact('form', 10);
                addLog(`‚úÖ Contact enviado (EMQ: ${result.emqScore})`, 'success');
                updateStats();
            } catch (error) {
                addLog(`‚ùå Erro no Contact: ${error.message}`, 'error');
            }
        }

        async function testInitiateCheckout() {
            addLog('üõí Testando InitiateCheckout...', 'info');
            try {
                const result = await TikTokEvents.trackInitiateCheckout('produto-123', 'Produto de Teste', 97.00);
                addLog(`‚úÖ InitiateCheckout enviado (EMQ: ${result.emqScore})`, 'success');
                updateStats();
            } catch (error) {
                addLog(`‚ùå Erro no InitiateCheckout: ${error.message}`, 'error');
            }
        }

        async function testPurchase() {
            addLog('üí∞ Testando Purchase...', 'info');
            try {
                const result = await TikTokEvents.trackPurchase('produto-123', 'Produto Comprado', 97.00);
                addLog(`‚úÖ Purchase enviado (EMQ: ${result.emqScore})`, 'success');
                updateStats();
            } catch (error) {
                addLog(`‚ùå Erro no Purchase: ${error.message}`, 'error');
            }
        }

        async function testClickButton() {
            addLog('üîò Testando ClickButton...', 'info');
            try {
                const result = await TikTokEvents.trackClickButton('Bot√£o de Teste', 'cta', 5);
                addLog(`‚úÖ ClickButton enviado (EMQ: ${result.emqScore})`, 'success');
                updateStats();
            } catch (error) {
                addLog(`‚ùå Erro no ClickButton: ${error.message}`, 'error');
            }
        }

        // Eventos espec√≠ficos do Devotly
        async function testDevotlyEvents(eventType) {
            addLog(`‚úùÔ∏è Testando ${eventType}...`, 'info');
            try {
                let result;
                switch (eventType) {
                    case 'viewHomePage':
                        result = await TikTokEvents.viewHomePage();
                        break;
                    case 'viewCreatePage':
                        result = await TikTokEvents.viewCreatePage();
                        break;
                    case 'viewCard':
                        result = await TikTokEvents.viewCard('card-123');
                        break;
                    case 'selectPlan':
                        result = await TikTokEvents.selectPlan('premium', 97);
                        break;
                    case 'startCheckout':
                        result = await TikTokEvents.startCheckout('card-123', 'premium', 97);
                        break;
                    case 'completePurchase':
                        result = await TikTokEvents.completePurchase('card-123', 'premium', 97);
                        break;
                }
                addLog(`‚úÖ ${eventType} enviado (EMQ: ${result.emqScore})`, 'success');
                updateStats();
            } catch (error) {
                addLog(`‚ùå Erro no ${eventType}: ${error.message}`, 'error');
            }
        }

        // Status do backend
        async function checkBackendStatus() {
            addLog('üìä Verificando status do backend...', 'info');
            try {
                const response = await fetch('/api/tiktok-v3/status');
                const data = await response.json();
                
                if (data.success) {
                    addLog(`‚úÖ Backend ativo - EMQ m√©dio: ${data.metrics.averageEMQ}`, 'success');
                    addLog(`üìä Eventos: ${data.metrics.totalEvents} (${data.metrics.successRate}% sucesso)`, 'info');
                } else {
                    addLog('‚ùå Erro no status do backend', 'error');
                }
            } catch (error) {
                addLog(`‚ùå Erro ao consultar backend: ${error.message}`, 'error');
            }
        }

        async function runBackendTest() {
            addLog('üß™ Executando teste de configura√ß√£o...', 'info');
            try {
                const response = await fetch('/api/tiktok-v3/test', { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    addLog(`‚úÖ Teste executado com sucesso (EMQ: ${data.testResult.emq_score})`, 'success');
                } else {
                    addLog(`‚ùå Teste falhou: ${data.message}`, 'error');
                }
            } catch (error) {
                addLog(`‚ùå Erro no teste: ${error.message}`, 'error');
            }
        }

        async function resetMetrics() {
            addLog('üîÑ Resetando m√©tricas...', 'info');
            try {
                const response = await fetch('/api/tiktok-v3/reset-metrics', { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    addLog('‚úÖ M√©tricas resetadas', 'success');
                    updateStats();
                } else {
                    addLog(`‚ùå Erro ao resetar: ${data.error}`, 'error');
                }
            } catch (error) {
                addLog(`‚ùå Erro: ${error.message}`, 'error');
            }
        }

        // Atualizar estat√≠sticas
        function updateStats() {
            const manager = window.TikTokManager;
            if (!manager) return;

            const metrics = manager.getQualityMetrics();
            
            document.getElementById('emqScore').textContent = metrics.averageEMQ.toFixed(1);
            document.getElementById('eventsSent').textContent = metrics.eventsSent;
            document.getElementById('successRate').textContent = 
                metrics.eventsSent > 0 ? ((metrics.eventsSuccess / metrics.eventsSent) * 100).toFixed(1) + '%' : '--';
            document.getElementById('hashSuccess').textContent = 
                metrics.hashSuccessRate ? metrics.hashSuccessRate.toFixed(1) + '%' : '--';
        }

        // Verificar quando TikTok Pixel carregar
        function checkTikTokPixel() {
            if (typeof ttq !== 'undefined') {
                addLog('‚úÖ TikTok Pixel carregado com sucesso', 'success');
                updateDataQuality();
                
                // Auto-detectar dados se dispon√≠veis
                const email = localStorage.getItem('devotly_user_email');
                const phone = localStorage.getItem('devotly_user_phone');
                if (email || phone) {
                    addLog('üîç Dados de usu√°rio detectados no cache', 'info');
                    if (email) document.getElementById('userEmail').value = email;
                    if (phone) document.getElementById('userPhone').value = phone;
                    updateDataQuality();
                }
            } else {
                setTimeout(checkTikTokPixel, 1000);
            }
        }

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', () => {
            addLog('üöÄ P√°gina carregada', 'info');
            checkTikTokPixel();
            updateDataQuality();
            updateStats();
        });
    </script>
</body>
</html>
