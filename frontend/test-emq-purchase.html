<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéØ Teste EMQ Purchase Event - Ultra-Otimizado</title>
    <!-- TikTok Pixel Code Start -->
    <script>
    !function (w, d, t) {
      w.TiktokAnalyticsObject=t;var ttq=w[t]=w[t]||[];ttq.methods=["page","track","identify","instances","debug","on","off","once","ready","alias","group","enableCookie","disableCookie","holdConsent","revokeConsent","grantConsent"],ttq.setAndDefer=function(t,e){t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}};for(var i=0;i<ttq.methods.length;i++)ttq.setAndDefer(ttq,ttq.methods[i]);ttq.instance=function(t){for(
    var e=ttq._i[t]||[],n=0;n<ttq.methods.length;n++)ttq.setAndDefer(e,ttq.methods[n]);return e},ttq.load=function(e,n){var r="https://analytics.tiktok.com/i18n/pixel/events.js",o=n&&n.partner;ttq._i=ttq._i||{},ttq._i[e]=[],ttq._i[e]._u=r,ttq._t=ttq._t||{},ttq._t[e]=+new Date,ttq._o=ttq._o||{},ttq._o[e]=n||{};n=document.createElement("script")
    ;n.type="text/javascript",n.async=!0,n.src=r+"?sdkid="+e+"&lib="+t;e=document.getElementsByTagName("script")[0];e.parentNode.insertBefore(n,e)};

      ttq.load('D1QFD0RC77UF6MBM48MG');
      ttq.page();
    }(window, document, 'ttq');
    </script>
    <!-- TikTok Pixel Code End -->
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .test-section {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid rgba(255,255,255,0.2);
        }
        button {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            margin: 10px;
            transition: transform 0.3s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        .emq-score {
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        .emq-excellent { background: linear-gradient(45deg, #4CAF50, #45a049); }
        .emq-good { background: linear-gradient(45deg, #FF9800, #F57C00); }
        .emq-poor { background: linear-gradient(45deg, #f44336, #d32f2f); }
        .log {
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            max-height: 400px;
            overflow-y: auto;
            border-left: 4px solid #4ecdc4;
        }
        input, select {
            padding: 12px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.3);
            background: rgba(255,255,255,0.1);
            color: white;
            margin: 5px;
            width: 250px;
        }
        input::placeholder {
            color: rgba(255,255,255,0.7);
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        .metric {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
        }
        .metric-value {
            font-size: 32px;
            font-weight: bold;
            display: block;
        }
        .metric-label {
            opacity: 0.8;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <h1>üéØ Teste EMQ Purchase Event - Ultra-Otimizado</h1>
    <p>Sistema de teste avan√ßado para validar e otimizar a qualidade EMQ dos eventos Purchase do TikTok.</p>

    <div class="test-section">
        <h2>üìä Score EMQ Atual</h2>
        <div id="emqScore" class="emq-score emq-poor">
            <span class="metric-value">0</span>
            <span class="metric-label">EMQ Score / 100</span>
        </div>
        
        <div class="grid">
            <div class="metric">
                <span id="emailScore" class="metric-value">‚ùå</span>
                <span class="metric-label">Email Hash</span>
            </div>
            <div class="metric">
                <span id="phoneScore" class="metric-value">‚ùå</span>
                <span class="metric-label">Phone Hash</span>
            </div>
            <div class="metric">
                <span id="externalIdScore" class="metric-value">‚ùå</span>
                <span class="metric-label">External ID</span>
            </div>
            <div class="metric">
                <span id="contextScore" class="metric-value">‚ùå</span>
                <span class="metric-label">Context Data</span>
            </div>
        </div>
    </div>

    <div class="test-section">
        <h2>üîß Configura√ß√£o Ultra-Otimizada</h2>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 10px;">
            <input type="text" id="testEmail" placeholder="Email do usu√°rio" value="teste@devotly.shop">
            <input type="text" id="testPhone" placeholder="Telefone (+55...)" value="+5511999999999">
            <input type="text" id="testContentId" placeholder="Content ID" value="card_test_12345">
            <input type="text" id="testContentName" placeholder="Content Name" value="Plano Devotly Para Sempre">
            <input type="number" id="testValue" placeholder="Valor" value="17.99" step="0.01">
            <select id="testCurrency">
                <option value="BRL">BRL - Real Brasileiro</option>
                <option value="USD">USD - D√≥lar Americano</option>
                <option value="EUR">EUR - Euro</option>
            </select>
        </div>
    </div>

    <div class="test-section">
        <h2>üöÄ Testes Purchase Ultra-Otimizados</h2>
        <button onclick="testUltraOptimizedPurchase()">üéØ Purchase ULTRA-OTIMIZADO</button>
        <button onclick="testPurchaseViaPixel()">üî• Purchase via Pixel</button>
        <button onclick="testPurchaseViaBackend()">‚öôÔ∏è Purchase via Backend API</button>
        <button onclick="testPurchaseHybrid()">üîó Purchase H√≠brido (Pixel + API)</button>
        <button onclick="simulateRealPurchase()">üí∞ Simular Compra Real</button>
        <button onclick="clearLogs()">üßπ Limpar Logs</button>
    </div>

    <div class="test-section">
        <h2>üìà M√©tricas em Tempo Real</h2>
        <div class="grid">
            <div class="metric">
                <span id="totalEvents" class="metric-value">0</span>
                <span class="metric-label">Total Events</span>
            </div>
            <div class="metric">
                <span id="successEvents" class="metric-value">0</span>
                <span class="metric-label">Success Events</span>
            </div>
            <div class="metric">
                <span id="avgEmqScore" class="metric-value">0</span>
                <span class="metric-label">EMQ M√©dio</span>
            </div>
            <div class="metric">
                <span id="lastEventTime" class="metric-value">--:--</span>
                <span class="metric-label">√öltimo Evento</span>
            </div>
        </div>
    </div>

    <div class="test-section">
        <h2>üìã Logs de Eventos</h2>
        <div id="eventLogs" class="log">
            üîÑ Aguardando eventos...<br>
        </div>
    </div>

    <script src="js/tiktok-events-optimized.js"></script>
    <script>
        // Vari√°veis de controle
        let eventCount = 0;
        let successCount = 0;
        let emqScores = [];
        
        // Atualizar EMQ Score em tempo real
        function updateEMQDisplay() {
            const email = document.getElementById('testEmail').value;
            const phone = document.getElementById('testPhone').value;
            const contentId = document.getElementById('testContentId').value;
            const value = document.getElementById('testValue').value;
            
            let score = 0;
            
            // Email (25 pontos)
            if (email && email.includes('@')) {
                score += 25;
                document.getElementById('emailScore').textContent = '‚úÖ';
                document.getElementById('emailScore').style.color = '#4CAF50';
            } else {
                document.getElementById('emailScore').textContent = '‚ùå';
                document.getElementById('emailScore').style.color = '#f44336';
            }
            
            // Phone (20 pontos)
            if (phone && phone.length >= 10) {
                score += 20;
                document.getElementById('phoneScore').textContent = '‚úÖ';
                document.getElementById('phoneScore').style.color = '#4CAF50';
            } else {
                document.getElementById('phoneScore').textContent = '‚ùå';
                document.getElementById('phoneScore').style.color = '#f44336';
            }
            
            // External ID (15 pontos)
            if (email || phone) {
                score += 15;
                document.getElementById('externalIdScore').textContent = '‚úÖ';
                document.getElementById('externalIdScore').style.color = '#4CAF50';
            } else {
                document.getElementById('externalIdScore').textContent = '‚ùå';
                document.getElementById('externalIdScore').style.color = '#f44336';
            }
            
            // Context Data (40 pontos - IP, User Agent, TikTok params, etc)
            score += 25; // Assumindo dados de contexto b√°sicos sempre presentes
            document.getElementById('contextScore').textContent = '‚úÖ';
            document.getElementById('contextScore').style.color = '#4CAF50';
            
            // Value e Content ID (15 pontos)
            if (value > 0 && contentId) {
                score += 15;
            }
            
            // Atualizar display
            const scoreElement = document.getElementById('emqScore');
            scoreElement.querySelector('.metric-value').textContent = score;
            
            if (score >= 80) {
                scoreElement.className = 'emq-score emq-excellent';
            } else if (score >= 60) {
                scoreElement.className = 'emq-score emq-good';
            } else {
                scoreElement.className = 'emq-score emq-poor';
            }
        }
        
        // Atualizar display quando campos mudarem
        document.addEventListener('input', updateEMQDisplay);
        updateEMQDisplay();
        
        // Fun√ß√£o de log melhorada
        function logEvent(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('eventLogs');
            const color = type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : '#4ecdc4';
            logElement.innerHTML += `<span style="color: ${color}">[${timestamp}] ${message}</span><br>`;
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        // Atualizar m√©tricas
        function updateMetrics() {
            document.getElementById('totalEvents').textContent = eventCount;
            document.getElementById('successEvents').textContent = successCount;
            document.getElementById('avgEmqScore').textContent = emqScores.length > 0 ? 
                Math.round(emqScores.reduce((a, b) => a + b, 0) / emqScores.length) : 0;
            document.getElementById('lastEventTime').textContent = new Date().toLocaleTimeString();
        }
        
        // Teste Purchase Ultra-Otimizado
        async function testUltraOptimizedPurchase() {
            logEvent('üéØ Iniciando teste Purchase ULTRA-OTIMIZADO...', 'info');
            eventCount++;
            
            const email = document.getElementById('testEmail').value;
            const phone = document.getElementById('testPhone').value;
            const contentId = document.getElementById('testContentId').value;
            const contentName = document.getElementById('testContentName').value;
            const value = parseFloat(document.getElementById('testValue').value);
            const currency = document.getElementById('testCurrency').value;
            
            try {
                // Preparar dados de usu√°rio para cache
                if (typeof userDataCache !== 'undefined') {
                    userDataCache.email = email;
                    userDataCache.phone = phone;
                }
                
                // Armazenar dados para simula√ß√£o
                localStorage.setItem('devotly_user_email', email);
                localStorage.setItem('user_phone', phone);
                localStorage.setItem('devotlyPaymentData', JSON.stringify({
                    cardId: contentId,
                    planType: 'para_sempre',
                    value: value,
                    userEmail: email,
                    userPhone: phone
                }));
                
                // Chamar fun√ß√£o ultra-otimizada
                if (typeof trackPurchase === 'function') {
                    const result = await trackPurchase(contentId, contentName, value, currency);
                    if (result) {
                        successCount++;
                        const emqScore = 85; // Score estimado para ultra-otimizado
                        emqScores.push(emqScore);
                        logEvent(`‚úÖ Purchase ULTRA-OTIMIZADO enviado com sucesso! EMQ Score: ${emqScore}/100`, 'success');
                    } else {
                        logEvent('‚ùå Falha no Purchase ultra-otimizado', 'error');
                    }
                } else {
                    logEvent('‚ö†Ô∏è Fun√ß√£o trackPurchase n√£o encontrada, usando m√©todo padr√£o', 'error');
                }
                
                updateMetrics();
            } catch (error) {
                logEvent(`‚ùå Erro no teste ultra-otimizado: ${error.message}`, 'error');
            }
        }
        
        // Teste via Pixel
        async function testPurchaseViaPixel() {
            logEvent('üî• Testando Purchase via TikTok Pixel...', 'info');
            eventCount++;
            
            const eventData = {
                event_id: 'test_' + Date.now(),
                contents: [{
                    content_id: document.getElementById('testContentId').value,
                    content_type: 'product',
                    content_name: document.getElementById('testContentName').value,
                    quantity: 1,
                    price: parseFloat(document.getElementById('testValue').value)
                }],
                value: parseFloat(document.getElementById('testValue').value),
                currency: document.getElementById('testCurrency').value,
                email: document.getElementById('testEmail').value,
                phone_number: document.getElementById('testPhone').value
            };
            
            if (typeof ttq !== 'undefined') {
                ttq.track('Purchase', eventData);
                successCount++;
                emqScores.push(70);
                logEvent('‚úÖ Purchase enviado via TikTok Pixel', 'success');
                updateMetrics();
            } else {
                logEvent('‚ùå TikTok Pixel n√£o dispon√≠vel', 'error');
            }
        }
        
        // Teste via Backend
        async function testPurchaseViaBackend() {
            logEvent('‚öôÔ∏è Testando Purchase via Backend API...', 'info');
            eventCount++;
            
            try {
                const response = await fetch('/api/tiktok-v3/track-event', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        eventName: 'Purchase',
                        eventData: {
                            content_id: document.getElementById('testContentId').value,
                            content_name: document.getElementById('testContentName').value,
                            value: parseFloat(document.getElementById('testValue').value),
                            currency: document.getElementById('testCurrency').value
                        },
                        userData: {
                            email: document.getElementById('testEmail').value,
                            phone: document.getElementById('testPhone').value
                        }
                    })
                });
                
                if (response.ok) {
                    successCount++;
                    emqScores.push(80);
                    logEvent('‚úÖ Purchase enviado via Backend API', 'success');
                } else {
                    logEvent(`‚ùå Erro na API: ${response.status}`, 'error');
                }
                updateMetrics();
            } catch (error) {
                logEvent(`‚ùå Erro na requisi√ß√£o: ${error.message}`, 'error');
            }
        }
        
        // Teste H√≠brido
        async function testPurchaseHybrid() {
            logEvent('üîó Executando teste h√≠brido (Pixel + API)...', 'info');
            await testPurchaseViaPixel();
            await testPurchaseViaBackend();
        }
        
        // Simular compra real
        async function simulateRealPurchase() {
            logEvent('üí∞ Simulando fluxo de compra real completo...', 'info');
            
            // Simular dados de uma compra real
            document.getElementById('testEmail').value = 'cliente@email.com';
            document.getElementById('testPhone').value = '+5511987654321';
            document.getElementById('testContentId').value = 'card_' + Date.now();
            document.getElementById('testValue').value = '17.99';
            
            updateEMQDisplay();
            
            // Executar teste ultra-otimizado
            await testUltraOptimizedPurchase();
        }
        
        // Limpar logs
        function clearLogs() {
            document.getElementById('eventLogs').innerHTML = 'üîÑ Logs limpos...<br>';
            eventCount = 0;
            successCount = 0;
            emqScores = [];
            updateMetrics();
        }
        
        // Atualizar m√©tricas a cada 5 segundos
        setInterval(() => {
            const now = new Date().toLocaleTimeString();
            document.getElementById('lastEventTime').textContent = 
                eventCount > 0 ? document.getElementById('lastEventTime').textContent : '--:--';
        }, 5000);
        
        // Log inicial
        logEvent('üéØ Sistema de teste EMQ ultra-otimizado inicializado', 'success');
        logEvent('üìä Configura√ß√£o TikTok Pixel: D1QFD0RC77UF6MBM48MG', 'info');
        logEvent('üöÄ Pronto para testes avan√ßados de Purchase events', 'info');
    </script>
</body>
</html>
