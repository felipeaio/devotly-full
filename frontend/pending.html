<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pagamento Pendente | Devotly</title>
    <!-- TikTok Pixel Code Start -->
<script>
!function (w, d, t) {
  w.TiktokAnalyticsObject=t;var ttq=w[t]=w[t]||[];ttq.methods=["page","track","identify","instances","debug","on","off","once","ready","alias","group","enableCookie","disableCookie","holdConsent","revokeConsent","grantConsent"],ttq.setAndDefer=function(t,e){t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}};for(var i=0;i<ttq.methods.length;i++)ttq.setAndDefer(ttq,ttq.methods[i]);ttq.instance=function(t){for(
var e=ttq._i[t]||[],n=0;n<ttq.methods.length;n++)ttq.setAndDefer(e,ttq.methods[n]);return e},ttq.load=function(e,n){var r="https://analytics.tiktok.com/i18n/pixel/events.js",o=n&&n.partner;ttq._i=ttq._i||{},ttq._i[e]=[],ttq._i[e]._u=r,ttq._t=ttq._t||{},ttq._t[e]=+new Date,ttq._o=ttq._o||{},ttq._o[e]=n||{};n=document.createElement("script")
;n.type="text/javascript",n.async=!0,n.src=r+"?sdkid="+e+"&lib="+t;e=document.getElementsByTagName("script")[0];e.parentNode.insertBefore(n,e)};


  ttq.load('D1QFD0RC77UF6MBM48MG');
  // PageView com valor ser√° disparado pelo TikTokEvents v3
}(window, document, 'ttq');
</script>
<!-- TikTok Pixel Code End -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@400;500;600&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="/css/style.css">
    <style>
        :root {
            --pending-padding-desktop: 3rem;
            --pending-padding-mobile: 1.5rem;
            --animation-duration: 0.5s;
        }

        .pending-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: clamp(1rem, 5vw, 3rem);
            text-align: center;
            background: linear-gradient(145deg, #FF8C00, #FFD700);
            position: relative;
            overflow: hidden;
        }

        .pending-content {
            max-width: min(600px, 90%);
            width: 100%;
            padding: clamp(1.5rem, 4vw, var(--pending-padding-desktop));
            background: rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            animation: slideUp var(--animation-duration) ease-out;
        }

        .pending-icon {
            font-size: clamp(3rem, 8vw, 4.5rem);
            color: #ffa502;
            margin-bottom: 1.5rem;
            animation: pulse 2s infinite;
            display: inline-block;
        }

        .pending-title {
            font-family: 'Crimson Pro', serif;
            font-size: clamp(1.8rem, 5vw, 2.8rem);
            font-weight: 600;
            color: white;
            margin-bottom: 1rem;
            line-height: 1.2;
        }

        .pending-message {
            font-size: clamp(1rem, 3vw, 1.2rem);
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 2rem;
            line-height: 1.6;
        }

        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-top: 2rem;
        }

        .btn {
            padding: 0.8rem 2rem;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.3s ease;
            cursor: pointer;
            font-size: 1rem;
        }

        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: transparent;
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.5);
        }
        
        .btn-warning {
            background: #ffa502;
            color: white;
            border: none;
        }
        
        .btn-warning:hover {
            background: #ff7f02;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 165, 2, 0.4);
        }
        
        .btn-warning:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-info {
            background: #3742fa;
            color: white;
            border: none;
        }
        
        .btn-info:hover {
            background: #2f3af2;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(55, 66, 250, 0.4);
        }
        
        .btn-info:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.7;
                transform: scale(1.1);
            }
        }

        .status-info {
            background: rgba(255, 255, 255, 0.1);
            padding: 1rem;
            border-radius: 10px;
            margin: 1.5rem 0;
            border-left: 4px solid #ffa502;
        }

        @media (min-width: 768px) {
            .action-buttons {
                flex-direction: row;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="pending-container">
        <div class="pending-content">
            <div class="pending-icon">
                <i class="fas fa-clock"></i>
            </div>
            
            <h1 class="pending-title">Pagamento Pendente</h1>
            
            <p class="pending-message">
                Seu pagamento est√° sendo processado! Dependendo da forma de pagamento escolhida, 
                pode levar alguns minutos ou at√© algumas horas para ser confirmado.
            </p>

            <div class="status-info">
                <strong>O que acontece agora?</strong><br>
                <small>
                    Voc√™ receber√° um email de confirma√ß√£o assim que o pagamento for aprovado.
                    Fique atento √† sua caixa de entrada!
                </small>
            </div>

            <div class="action-buttons">
                <a href="/" class="btn btn-primary">
                    <i class="fas fa-home"></i>
                    Voltar ao In√≠cio
                </a>
                <a href="/create/create.html" class="btn btn-secondary">
                    <i class="fas fa-plus"></i>
                    Criar Outro Cart√£o
                </a>
                
                <!-- Bot√£o de emerg√™ncia para processamento manual -->
                <button id="manualProcessBtn" class="btn btn-warning" style="background: #ffa502; display: none; margin-top: 1rem;">
                    <i class="fas fa-tools"></i>
                    Processar Pagamento Manualmente
                </button>
                
                <!-- Bot√£o para testar conectividade -->
                <button id="testConnBtn" class="btn btn-info" style="background: #3742fa; color: white; display: none; margin-top: 0.5rem;">
                    <i class="fas fa-network-wired"></i>
                    Testar Conectividade
                </button>
                
                <!-- Bot√£o de debug do pagamento -->
                <button id="debugPaymentBtn" class="btn btn-secondary" style="display: none; margin-top: 0.5rem;">
                    <i class="fas fa-bug"></i>
                    Debug Pagamento
                </button>
            </div>
            
            <!-- Log de debug -->
            <div id="debugLog" style="display: none; background: rgba(0,0,0,0.8); color: #00ff00; padding: 1rem; border-radius: 5px; margin-top: 1rem; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto;">
            </div>
        </div>
    </div>    <script>
        // Capturar par√¢metros da URL para logging e verifica√ß√£o de status
        const urlParams = new URLSearchParams(window.location.search);
        const paymentParams = Object.fromEntries(urlParams.entries());
        console.log('Par√¢metros do pagamento pendente:', paymentParams);

        // Extrair informa√ß√µes importantes
        const paymentId = paymentParams.payment_id;
        const externalReference = paymentParams.external_reference;
        const paymentType = paymentParams.payment_type;
        
        // Fun√ß√£o para adicionar logs de debug
        function addDebugLog(message) {
            const debugLog = document.getElementById('debugLog');
            debugLog.style.display = 'block';
            const timestamp = new Date().toLocaleTimeString();
            debugLog.innerHTML += `[${timestamp}] ${message}<br>`;
            debugLog.scrollTop = debugLog.scrollHeight;
            console.log(`[DEBUG] ${message}`);
        }
        
        // Fun√ß√£o para processar pagamento manualmente
        async function processPaymentManually() {
            if (!paymentId) {
                alert('Payment ID n√£o encontrado');
                return;
            }
            
            addDebugLog(`üîÑ PROCESSAMENTO MANUAL INICIADO para pagamento ${paymentId}`);
            const manualBtn = document.getElementById('manualProcessBtn');
            manualBtn.disabled = true;
            manualBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processando...';
            
            try {
                // SEMPRE usar conex√£o direta com Railway para processamento manual
                addDebugLog('üéØ Usando conex√£o DIRETA com Railway para processamento manual...');
                
                const response = await fetch(`https://devotly-full-production.up.railway.app/webhook/manual-process/${paymentId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'User-Agent': navigator.userAgent
                    },
                    body: JSON.stringify({
                        source: 'pending_page_manual',
                        timestamp: new Date().toISOString(),
                        userAgent: navigator.userAgent,
                        referrer: window.location.href
                    })
                });
                
                addDebugLog(`‚úÖ Resposta do servidor: status ${response.status}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                addDebugLog(`üìã Resultado: ${JSON.stringify(result, null, 2)}`);
                
                if (result.success) {
                    addDebugLog('‚úÖ PAGAMENTO PROCESSADO COM SUCESSO!');
                    
                    // Mostrar mensagem de sucesso
                    alert('‚úÖ Pagamento processado com sucesso! Voc√™ ser√° redirecionado em 3 segundos...');
                    
                    // Aguardar 3 segundos e redirecionar
                    setTimeout(() => {
                        if (result.redirectUrl) {
                            addDebugLog(`üîÑ Redirecionando para: ${result.redirectUrl}`);
                            window.location.href = result.redirectUrl;
                        } else {
                            addDebugLog('üîÑ Redirecionando para success page...');
                            window.location.href = `/success.html?${window.location.search.substring(1)}`;
                        }
                    }, 3000);
                    
                } else {
                    addDebugLog(`‚ùå Erro retornado pelo servidor: ${result.message || result.error}`);
                    alert(`‚ùå Erro: ${result.message || result.error}\n\nPor favor, entre em contato com o suporte.`);
                }
                
            } catch (error) {
                addDebugLog(`‚ùå ERRO CR√çTICO na requisi√ß√£o: ${error.message}`);
                console.error('Erro completo:', error);
                
                alert(`‚ùå Erro de comunica√ß√£o: ${error.message}\n\nVerifique sua conex√£o e tente novamente ou entre em contato com o suporte.`);
                
            } finally {
                manualBtn.disabled = false;
                manualBtn.innerHTML = '<i class="fas fa-tools"></i> Processar Pagamento Manualmente';
            }
        }
        
        // Fun√ß√£o para testar conectividade
        async function testConnectivity() {
            addDebugLog('üîç TESTANDO CONECTIVIDADE...');
            const testBtn = document.getElementById('testConnBtn');
            testBtn.disabled = true;
            testBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testando...';
            
            const tests = [
                { name: 'Railway Health', url: 'https://devotly-full-production.up.railway.app/health' },
                { name: 'Railway Status', url: 'https://devotly-full-production.up.railway.app/status' },
                { name: 'Backend Root', url: 'https://devotly-full-production.up.railway.app/' }
            ];
            
            for (const test of tests) {
                try {
                    addDebugLog(`üß™ Testando: ${test.name}...`);
                    const response = await fetch(test.url, { 
                        method: 'GET',
                        headers: { 'Accept': 'application/json' }
                    });
                    addDebugLog(`‚úÖ ${test.name}: ${response.status} ${response.statusText}`);
                } catch (error) {
                    addDebugLog(`‚ùå ${test.name}: ${error.message}`);
                }
            }
            
            testBtn.disabled = false;
            testBtn.innerHTML = '<i class="fas fa-network-wired"></i> Testar Conectividade';
        }
        
        // Fun√ß√£o para debug do pagamento
        async function debugPayment() {
            if (!paymentId) {
                addDebugLog('‚ùå Payment ID n√£o dispon√≠vel para debug');
                return;
            }
            
            addDebugLog(`üîç DEBUG DO PAGAMENTO ${paymentId}...`);
            const debugBtn = document.getElementById('debugPaymentBtn');
            debugBtn.disabled = true;
            debugBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Debugando...';
            
            try {
                const response = await fetch(`https://devotly-full-production.up.railway.app/webhook/debug/payment/${paymentId}`, {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' }
                });
                
                if (response.ok) {
                    const debugData = await response.json();
                    addDebugLog('üìä DADOS DO PAGAMENTO:');
                    addDebugLog(`Status: ${debugData.paymentInfo?.status}`);
                    addDebugLog(`Valor: ${debugData.paymentInfo?.total_amount}`);
                    addDebugLog(`M√©todo: ${debugData.paymentInfo?.payment_method?.type}`);
                    addDebugLog(`Card ID: ${debugData.cardId}`);
                    addDebugLog(`Pode processar: ${debugData.canProcess ? '‚úÖ SIM' : '‚ùå N√ÉO'}`);
                    addDebugLog(`Dados completos: ${JSON.stringify(debugData, null, 2)}`);
                    
                    if (debugData.canProcess) {
                        addDebugLog('‚úÖ Pagamento pode ser processado! Mostrando bot√£o manual...');
                        document.getElementById('manualProcessBtn').style.display = 'block';
                    }
                } else {
                    addDebugLog(`‚ùå Erro no debug: ${response.status} ${response.statusText}`);
                }
                
            } catch (error) {
                addDebugLog(`‚ùå Erro no debug: ${error.message}`);
            } finally {
                debugBtn.disabled = false;
                debugBtn.innerHTML = '<i class="fas fa-bug"></i> Debug Pagamento';
            }
        }
        
        // Configurar bot√µes
        document.getElementById('manualProcessBtn').addEventListener('click', processPaymentManually);
        document.getElementById('testConnBtn').addEventListener('click', testConnectivity);
        document.getElementById('debugPaymentBtn').addEventListener('click', debugPayment);
        
        // Logs iniciais
        addDebugLog('=== PENDING PAGE INICIADA ===');
        addDebugLog(`Payment ID: ${paymentId}`);
        addDebugLog(`External Reference: ${externalReference}`);
        addDebugLog(`Payment Type: ${paymentType}`);
        addDebugLog(`URL Completa: ${window.location.href}`);

        // Fun√ß√£o para verificar status do pagamento
        let failedAttempts = 0;
        let maxFailedAttempts = 2; // Reduzido para mostrar bot√£o mais r√°pido
        
        async function checkPaymentStatus() {
            if (!paymentId) {
                addDebugLog('‚ùå Payment ID n√£o encontrado nos par√¢metros');
                document.getElementById('manualProcessBtn').style.display = 'block';
                return;
            }

            try {
                addDebugLog(`üîç Verificando status do pagamento: ${paymentId} (tentativa ${failedAttempts + 1})`);
                
                // Se h√° external_reference, extrair o cardId
                let cardId = null;
                if (externalReference) {
                    const decodedRef = decodeURIComponent(externalReference);
                    cardId = decodedRef.split('|')[0];
                    addDebugLog(`Card ID extra√≠do: ${cardId}`);
                }

                if (!cardId) {
                    addDebugLog('‚ùå Card ID n√£o encontrado na refer√™ncia externa');
                    document.getElementById('manualProcessBtn').style.display = 'block';
                    return;
                }

                // FOR√áAR USO DIRETO DO RAILWAY - pular proxy completamente
                let response;
                let usedDirectConnection = false;
                
                // Tentar proxy APENAS uma vez, depois ir direto para Railway
                if (failedAttempts === 0) {
                    try {
                        addDebugLog('üîÑ Tentativa 1: Usando proxy...');
                        response = await fetch(`/api/cards/${cardId}/status`, { timeout: 3000 });
                        addDebugLog(`‚úÖ Proxy funcionou: status ${response.status}`);
                    } catch (proxyError) {
                        addDebugLog(`‚ùå Proxy falhou: ${proxyError.message}`);
                        response = null;
                    }
                }
                
                // Se proxy falhou ou √© a segunda tentativa, ir direto para Railway
                if (!response || !response.ok || failedAttempts > 0) {
                    addDebugLog('üéØ Usando conex√£o DIRETA com Railway...');
                    try {
                        response = await fetch(`https://devotly-full-production.up.railway.app/api/cards/${cardId}/status`, {
                            method: 'GET',
                            headers: {
                                'Accept': 'application/json',
                                'User-Agent': navigator.userAgent
                            }
                        });
                        usedDirectConnection = true;
                        addDebugLog(`‚úÖ Conex√£o direta: status ${response.status}`);
                    } catch (railwayError) {
                        addDebugLog(`‚ùå Erro tamb√©m no Railway: ${railwayError.message}`);
                        failedAttempts++;
                        
                        // Mostrar bot√£o de emerg√™ncia imediatamente se Railway tamb√©m falhou
                        if (failedAttempts >= 1) {
                            addDebugLog('ÔøΩ EMERG√äNCIA: Mostrando bot√£o de processamento manual');
                            document.getElementById('manualProcessBtn').style.display = 'block';
                        }
                        return;
                    }
                }
                
                if (response && response.ok) {
                    const data = await response.json();
                    const connectionType = usedDirectConnection ? 'DIRETA' : 'PROXY';
                    addDebugLog(`‚úÖ [${connectionType}] Status do cart√£o: ${data.status_pagamento}`);
                    
                    if (data.status_pagamento === 'aprovado') {
                        addDebugLog('üéâ PAGAMENTO APROVADO! Redirecionando...');
                        window.location.href = `/success.html?${window.location.search.substring(1)}`;
                        return;
                    }
                    
                    // Reset failed attempts se conseguiu conectar
                    failedAttempts = 0;
                } else {
                    addDebugLog(`‚ùå Erro HTTP: status ${response?.status}`);
                    failedAttempts++;
                }
                
                // Mostrar bot√£o de emerg√™ncia ap√≥s poucas tentativas
                if (failedAttempts >= maxFailedAttempts) {
                    addDebugLog('‚ö†Ô∏è Muitas tentativas falharam. Mostrando bot√£o de processamento manual.');
                    document.getElementById('manualProcessBtn').style.display = 'block';
                }
                
            } catch (error) {
                addDebugLog(`‚ùå Erro geral: ${error.message}`);
                failedAttempts++;
                
                // Mostrar bot√£o de emerg√™ncia ap√≥s poucas tentativas
                if (failedAttempts >= maxFailedAttempts) {
                    addDebugLog('‚ö†Ô∏è Muitas tentativas falharam. Mostrando bot√£o de processamento manual.');
                    document.getElementById('manualProcessBtn').style.display = 'block';
                }
            }
        }

        // Verificar status imediatamente e depois a cada 10 segundos
        checkPaymentStatus();
        
        // Mostrar bot√µes de debug ap√≥s 10 segundos
        setTimeout(() => {
            addDebugLog('‚è±Ô∏è Mostrando bot√µes de debug ap√≥s 10 segundos...');
            document.getElementById('testConnBtn').style.display = 'block';
            document.getElementById('debugPaymentBtn').style.display = 'block';
        }, 10000);
        
        // Para pagamentos PIX, verificar com mais frequ√™ncia inicialmente
        if (paymentType === 'bank_transfer') {
            addDebugLog('üí∞ Pagamento PIX detectado - verificando status automaticamente a cada 5 segundos');
            
            // Verificar a cada 5 segundos nos primeiros 2 minutos
            const frequentCheck = setInterval(() => {
                checkPaymentStatus();
            }, 5000);
            
            // Ap√≥s 1 minuto, reduzir para verificar a cada 15 segundos
            setTimeout(() => {
                clearInterval(frequentCheck);
                addDebugLog('‚è±Ô∏è Reduzindo frequ√™ncia de verifica√ß√£o para 15 segundos...');
                const normalCheck = setInterval(() => {
                    checkPaymentStatus();
                }, 15000);
                
                // Parar verifica√ß√µes ap√≥s 10 minutos
                setTimeout(() => {
                    addDebugLog('‚è±Ô∏è Parando verifica√ß√µes autom√°ticas ap√≥s 10 minutos');
                    clearInterval(normalCheck);
                }, 600000); // 10 minutos
            }, 60000); // 1 minuto
        } else {
            // Para outros tipos de pagamento, verificar a cada 30 segundos
            const normalCheck = setInterval(() => {
                checkPaymentStatus();
            }, 30000);
            
            // Parar verifica√ß√µes ap√≥s 5 minutos
            setTimeout(() => {
                clearInterval(normalCheck);
            }, 300000); // 5 minutos
        }

        // Adicionar contador visual para PIX
        if (paymentType === 'bank_transfer') {
            const messageElement = document.querySelector('.pending-message');
            if (messageElement) {
                messageElement.innerHTML = `
                    <strong>PIX detectado!</strong><br>
                    Seu pagamento est√° sendo processado automaticamente. 
                    Esta p√°gina ser√° atualizada assim que o pagamento for confirmado.
                    <br><br>
                    <small><i class="fas fa-sync fa-spin"></i> Verificando status automaticamente...</small>
                `;
            }
        }
    </script>
    <script src="js/tiktok-events-v3.js"></script>
</body>
</html>
